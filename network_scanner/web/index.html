<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Scanner - Home Assistant</title>
    <style>
        :root {
            /* Dark mode colors (default) */
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --text-link: #58a6ff;
            --button-primary: #238636;
            --button-primary-hover: #2ea043;
            --button-secondary: #21262d;
            --button-secondary-hover: #30363d;
            --status-online: #3fb950;
            --status-offline: #f85149;
        }

        body.light-mode {
            /* Light mode colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f6f8fa;
            --bg-tertiary: #ffffff;
            --border-color: #d0d7de;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --text-link: #0969da;
            --button-primary: #1f883d;
            --button-primary-hover: #1a7f37;
            --button-secondary: #f6f8fa;
            --button-secondary-hover: #f3f4f6;
            --status-online: #1a7f37;
            --status-offline: #d1242f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        h1 {
            color: var(--text-link);
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            background: var(--button-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--button-primary-hover);
        }

        button:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        button.secondary {
            background: var(--button-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        button.secondary:hover {
            background: var(--button-secondary-hover);
        }

        .action-dropdown {
            background: var(--button-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            width: 130px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-link);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: var(--status-online);
        }

        .status-scanning {
            background: #f0883e;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .search-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            flex: 1;
            min-width: 250px;
        }

        .devices-table {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-tertiary);
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:last-child td {
            border-bottom: none;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .device-ip {
            color: var(--text-link);
            font-weight: 600;
        }

        .device-hostname {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .device-mac {
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
        }

        .device-vendor {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .ports-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .port-badge {
            background: #1f6feb;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.2s;
        }

        .port-badge:hover {
            background: #388bfd;
            transform: translateY(-1px);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--text-link);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .last-update {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 10px;
        }

        .subnet-config {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .subnet-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .subnet-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .subnet-tag {
            background: #1f6feb;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .subnet-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .context-menu {
            display: none;
            position: fixed;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 5px 0;
            min-width: 150px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: var(--border-color);
        }

        .context-menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }

        .row-actions {
            position: relative;
            display: inline-block;
        }

        .action-btn {
            background: var(--button-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-link);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .action-btn:hover {
            background: var(--button-secondary-hover);
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 5px 0;
            min-width: 180px;
            max-height: 400px;
            overflow-y: auto;
            overflow-x: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 1000;
            margin-top: 5px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu.dropdown-up {
            bottom: 100%;
            margin-top: 0;
            margin-bottom: 5px;
        }

        /* Custom scrollbar for dropdown */
        .dropdown-menu::-webkit-scrollbar {
            width: 8px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .dropdown-item {
            padding: 8px 15px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 14px;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background: var(--border-color);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 5px 0;
        }

        /* SSH Modal & Protocol Modal */
        .ssh-modal, .protocol-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .ssh-modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            height: 80%;
            max-height: 600%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        }

        .ssh-modal-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .ssh-modal-title {
            color: var(--text-link);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ssh-modal-close {
            background: var(--button-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .ssh-modal-close:hover {
            background: var(--button-secondary-hover);
        }

        .ssh-modal-body {
            flex: 1;
            overflow: hidden;
        }

        .ssh-modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Protocol Selection Modal */
        .protocol-modal-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        }

        .protocol-modal-title {
            color: var(--text-link);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }

        .protocol-modal-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 25px;
            text-align: center;
        }

        .protocol-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .protocol-link {
            flex: 1;
            background: #238636;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        .protocol-link:hover {
            background: #2ea043;
            transform: translateY(-2px);
        }

        .protocol-link.https {
            background: #1f6feb;
        }

        .protocol-link.https:hover {
            background: #388bfd;
        }

        .protocol-cancel {
            background: var(--button-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
            width: 100%;
        }

        .protocol-cancel:hover {
            background: var(--button-secondary-hover);
        }

        /* Ping Modal */
        .ping-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .ping-modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9);
        }

        .ping-output {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 13px;
            color: var(--text-primary);
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .ping-success {
            color: var(--status-online);
        }

        .ping-fail {
            color: var(--status-offline);
        }

        .ping-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Status Dot */
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-dot.online {
            background: var(--status-online);
            box-shadow: 0 0 8px var(--status-online);
        }

        .status-dot.offline {
            background: var(--status-offline);
            box-shadow: 0 0 8px var(--status-offline);
        }

        /* Auto-refresh toggle */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: var(--button-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: var(--button-primary);
        }

        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(26px);
        }

        .toggle-label {
            color: var(--text-secondary);
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Network Scanner</h1>
            <div class="controls">
                <button id="scanBtn" onclick="startScan()">
                    <span id="scanBtnText">Scan Network</span>
                </button>
                <button class="secondary" onclick="refreshResults()">Refresh</button>
                <button class="secondary" onclick="exportJSON()">Export JSON</button>
                <button class="secondary" onclick="exportCSV()">Export CSV</button>
                <input type="text" class="search-box" id="searchBox" placeholder="Search devices..." oninput="filterDevices()">
                <div class="toggle-container">
                    <span class="toggle-label">Auto-refresh</span>
                    <div class="toggle-switch" id="autoRefreshToggle" onclick="toggleAutoRefresh()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <button class="secondary" onclick="toggleTheme()" id="themeToggle" title="Toggle light/dark mode">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
            </div>
        </header>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="subnet-config" style="margin-bottom: 0; min-height: 180px;">
                <div class="stat-label">Subnets to Scan</div>
                <div id="subnetTags" style="margin: 10px 0; min-height: 32px; display: flex; gap: 10px; flex-wrap: wrap;"></div>
                <div class="subnet-inputs">
                    <input type="text" class="subnet-input" id="subnetInput" placeholder="Add subnet: e.g., 192.168.1.0/24 or 'auto'" onkeypress="if(event.key==='Enter'){addSubnet();event.preventDefault();}">
                    <button onclick="addSubnet()">Add Subnet</button>
                </div>
            </div>

            <div class="subnet-config" style="margin-bottom: 0; min-height: 180px;">
                <div class="stat-label">Ports to Scan</div>
                <div style="margin: 10px 0; min-height: 32px;"></div>
                <div class="subnet-inputs">
                    <input type="text" class="subnet-input" id="portsInput" placeholder="Comma-separated ports: e.g., 22,80,443,8123" value="22,80,443,8123">
                </div>
                <div class="last-update" style="margin-top: 10px;">
                    Common: 22 (SSH), 80 (HTTP), 443 (HTTPS), 8123 (HA), 554 (RTSP), 3389 (RDP)
                </div>
            </div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-label">Total Devices</div>
                <div class="stat-value" id="totalDevices">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Status</div>
                <div class="stat-value">
                    <span class="status-indicator status-online" id="statusIndicator"></span>
                    <span id="statusText">Ready</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last Refreshed</div>
                <div class="stat-value" id="lastUpdate" style="font-size: 16px;">Never</div>
                <div class="stat-label" id="autoRefreshInfo" style="font-size: 11px; margin-top: 5px;">Auto-refresh: ON (every 5s)</div>
            </div>
        </div>

        <div class="devices-table">
            <table>
                <thead>
                    <tr>
                        <th>IP Address</th>
                        <th>Hostname</th>
                        <th>MAC Address</th>
                        <th>Vendor</th>
                        <th>Open Ports</th>
                        <th style="width: 120px;">Actions</th>
                    </tr>
                </thead>
                <tbody id="devicesTableBody">
                    <tr>
                        <td colspan="6" class="no-data">No devices found. Click "Start Scan" to begin.</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="last-update" style="text-align: center; margin-top: 20px; padding: 20px; color: var(--text-link);">
            Built by <strong><a href="https://onoffautomations.com" target="_blank" style="color: var(--text-link); text-decoration: none;">OnOff Automations</a></strong>
        </div>
    </div>

    <!-- SSH Modal -->
    <div class="ssh-modal" id="sshModal" onclick="if(event.target === this) closeSSHModal()">
        <div class="ssh-modal-content">
            <div class="ssh-modal-header">
                <div class="ssh-modal-title">
                    üíª SSH Connection - <span id="sshIP"></span>
                </div>
                <button class="ssh-modal-close" onclick="closeSSHModal()">Close</button>
            </div>
            <div class="ssh-modal-body">
                <iframe id="sshFrame"></iframe>
            </div>
        </div>
    </div>

    <!-- Protocol Selection Modal -->
    <div class="protocol-modal" id="protocolModal" onclick="if(event.target === this) closeProtocolModal()">
        <div class="protocol-modal-content">
            <div class="protocol-modal-title">Select Protocol</div>
            <div class="protocol-modal-subtitle">Choose how to open <span id="protocolIP"></span></div>
            <div class="protocol-options">
                <a class="protocol-link https" id="protocolHttpsLink" target="_blank" onclick="closeProtocolModal()">
                    üîí HTTPS
                </a>
                <a class="protocol-link" id="protocolHttpLink" target="_blank" onclick="closeProtocolModal()">
                    üåê HTTP
                </a>
            </div>
            <button class="protocol-cancel" onclick="closeProtocolModal()">Cancel</button>
        </div>
    </div>

    <!-- Ping Modal -->
    <div class="ping-modal" id="pingModal" onclick="if(event.target === this) closePingModal()">
        <div class="ping-modal-content">
            <div class="ssh-modal-header">
                <div class="ssh-modal-title">
                    üì° Ping - <span id="pingIP"></span>
                </div>
                <button class="ssh-modal-close" onclick="closePingModal()">Close</button>
            </div>
            <div class="ssh-modal-body" style="padding: 20px;">
                <div class="ping-output" id="pingOutput">Starting ping...</div>
                <div class="ping-actions">
                    <button onclick="runMorePings()" id="pingMoreBtn">Ping 8 More</button>
                    <button class="secondary" onclick="closePingModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allDevices = [];
        let autoRefreshInterval = null;
        let subnets = ['auto'];

        // Get base path for API calls (works with ingress)
        function getBasePath() {
            // Use current path as base - works for both direct and ingress access
            const path = window.location.pathname;
            // If path ends with /, use it as is, otherwise add /
            return path.endsWith('/') ? path : path + '/';
        }

        // Helper function for API calls with correct path
        async function apiCall(endpoint, options = {}) {
            const basePath = getBasePath();
            const url = basePath + endpoint.replace(/^\//, ''); // Remove leading slash if present
            console.log('API call:', url);
            return fetch(url, options);
        }

        function addSubnet() {
            const input = document.getElementById('subnetInput');
            const subnet = input.value.trim();

            if (subnet && !subnets.includes(subnet)) {
                subnets.push(subnet);
                updateSubnetTags();
                input.value = '';
            }
        }

        function removeSubnet(subnet) {
            subnets = subnets.filter(s => s !== subnet);
            updateSubnetTags();
        }

        function updateSubnetTags() {
            const container = document.getElementById('subnetTags');
            container.innerHTML = subnets.map(subnet => `
                <div class="subnet-tag">
                    ${subnet}
                    <span class="remove" onclick="removeSubnet('${subnet}')">&times;</span>
                </div>
            `).join('');
        }

        async function startScan() {
            const btn = document.getElementById('scanBtn');
            const btnText = document.getElementById('scanBtnText');
            btn.disabled = true;
            btnText.textContent = 'Starting...';

            try {
                // Get ports from input field
                const portsInput = document.getElementById('portsInput').value.trim();
                const ports = portsInput || '22,80,443,8123';

                console.log('Starting scan with subnets:', subnets, 'ports:', ports);

                const response = await apiCall('api/scan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subnets: subnets, ports: ports })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                // Get the response text first to debug
                const responseText = await response.text();
                console.log('Response text:', responseText);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseText.substring(0, 200)}`);
                }

                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON parse error:', e);
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}`);
                }

                if (data.status === 'success') {
                    btnText.textContent = 'Scanning...';
                    updateStatus(true);
                    setTimeout(refreshResults, 2000);
                } else {
                    alert(data.message || 'Failed to start scan');
                    btnText.textContent = 'Scan Network';
                    btn.disabled = false;
                }
            } catch (error) {
                console.error('Error starting scan:', error);
                alert('Failed to start scan:\n' + error.message);
                btnText.textContent = 'Scan Network';
                btn.disabled = false;
            }
        }

        async function refreshResults() {
            try {
                const response = await apiCall('api/results');

                if (!response.ok) {
                    console.error('Results fetch failed:', response.status);
                    return;
                }

                const responseText = await response.text();
                let data;

                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON parse error in results:', e, responseText.substring(0, 200));
                    return;
                }

                allDevices = data.devices || [];
                updateUI(data);
                filterDevices();

                updateStatus(data.is_scanning);

            } catch (error) {
                console.error('Error fetching results:', error);
            }
        }

        function updateUI(data) {
            document.getElementById('totalDevices').textContent = data.total_devices || 0;

            if (data.last_update) {
                const date = new Date(data.last_update);
                document.getElementById('lastUpdate').textContent = date.toLocaleTimeString();
            }
        }

        function updateStatus(isScanning) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const scanBtn = document.getElementById('scanBtn');
            const scanBtnText = document.getElementById('scanBtnText');

            if (isScanning) {
                indicator.className = 'status-indicator status-scanning';
                statusText.textContent = 'Scanning...';
                scanBtnText.textContent = 'Scanning...';
                scanBtn.disabled = true;
            } else {
                indicator.className = 'status-indicator status-online';
                statusText.textContent = 'Ready';
                scanBtnText.textContent = 'Scan Network';
                scanBtn.disabled = false;
            }
        }

        function filterDevices() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const filteredDevices = allDevices.filter(device => {
                return device.ip.toLowerCase().includes(searchTerm) ||
                       (device.hostname && device.hostname.toLowerCase().includes(searchTerm)) ||
                       (device.mac && device.mac.toLowerCase().includes(searchTerm)) ||
                       (device.vendor && device.vendor.toLowerCase().includes(searchTerm));
            });

            renderDevices(filteredDevices);
        }

        function renderDevices(devices) {
            const tbody = document.getElementById('devicesTableBody');

            if (devices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">No devices found. Click "Scan Network" to begin.</td></tr>';
                return;
            }

            tbody.innerHTML = devices.map((device, idx) => `
                <tr data-device-index="${idx}">
                    <td>
                        <div class="device-ip">
                            <span class="status-dot online"></span>${device.ip}
                        </div>
                    </td>
                    <td>
                        <div class="device-hostname">${device.hostname || '-'}</div>
                    </td>
                    <td>
                        <div class="device-mac">${device.mac || '-'}</div>
                    </td>
                    <td>
                        <div class="device-vendor">${device.vendor || '-'}</div>
                    </td>
                    <td>
                        <div class="ports-list">
                            ${device.ports && device.ports.length > 0
                                ? device.ports.map(p => `<span class="port-badge" onclick="openPort('${device.ip}', ${p.port})" title="Click to open ${device.ip}:${p.port}">${p.port}/${p.service || 'tcp'}</span>`).join('')
                                : '-'
                            }
                        </div>
                    </td>
                    <td>
                        <select class="action-dropdown" onchange="handleAction(this.value, ${idx})">
                            <option value="">Select Action‚Ä¶</option>
                            <option value="ping">üì° Ping Device</option>
                            <option value="copy_ip">üìã Copy IP</option>
                            <option value="copy_hostname">üìã Copy Hostname</option>
                            <option value="copy_mac">üìã Copy MAC</option>
                            <option value="copy_vendor">üìã Copy Vendor</option>
                            <option value="copy_all">üìã Copy All Info</option>
                        </select>
                    </td>
                </tr>
            `).join('');
        }

        function toggleDropdown(idx, event) {
            event.stopPropagation();
            const dropdown = document.getElementById(`dropdown-${idx}`);
            const button = event.target.closest('button');

            // Close all other dropdowns
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                if (menu !== dropdown) {
                    menu.classList.remove('show');
                    menu.classList.remove('dropdown-up');
                }
            });

            // Toggle show/hide
            const isShowing = dropdown.classList.contains('show');
            dropdown.classList.toggle('show');

            if (!isShowing) {
                // Calculate if dropdown should open upward
                const buttonRect = button.getBoundingClientRect();
                const dropdownHeight = 400; // Max height of dropdown
                const spaceBelow = window.innerHeight - buttonRect.bottom;
                const spaceAbove = buttonRect.top;

                // If not enough space below but enough above, open upward
                if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
                    dropdown.classList.add('dropdown-up');
                } else {
                    dropdown.classList.remove('dropdown-up');
                }
            }
        }

        function copyToClipboard(text) {
            // Try modern clipboard API first (works in secure contexts)
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text)
                    .then(() => true)
                    .catch(() => {
                        // Fallback if clipboard API fails
                        return fallbackCopy(text);
                    });
            }

            // Use fallback method directly
            return fallbackCopy(text);
        }

        function fallbackCopy(text) {
            // Create temporary textarea element
            const textArea = document.createElement('textarea');
            textArea.value = text;

            // Make it invisible and position off-screen
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            textArea.style.opacity = '0';

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return Promise.resolve(successful);
            } catch (err) {
                document.body.removeChild(textArea);
                return Promise.resolve(false);
            }
        }

        function copyField(field, idx) {
            const device = allDevices[idx];
            if (!device) return;

            let text = '';
            switch(field) {
                case 'ip':
                    text = device.ip;
                    break;
                case 'hostname':
                    text = device.hostname || '';
                    break;
                case 'mac':
                    text = device.mac || '';
                    break;
                case 'vendor':
                    text = device.vendor || '';
                    break;
                case 'all':
                    text = `IP: ${device.ip}\nHostname: ${device.hostname || 'N/A'}\nMAC: ${device.mac || 'N/A'}\nVendor: ${device.vendor || 'N/A'}`;
                    break;
            }

            if (!text) {
                alert('Nothing to copy');
                return;
            }

            copyToClipboard(text).then((success) => {
                if (success) {
                    console.log('Copied:', text);
                } else {
                    alert('Copy failed. Please try manually selecting the text.');
                    console.error('Failed to copy:', text);
                }
            });
        }

        function handleAction(action, idx) {
            if (!action) return;
            const device = allDevices[idx];
            if (!device) return;

            switch (action) {
                case 'ping':
                    startPing(idx);
                    break;
                case 'copy_ip':
                    copyField('ip', idx);
                    break;
                case 'copy_hostname':
                    copyField('hostname', idx);
                    break;
                case 'copy_mac':
                    copyField('mac', idx);
                    break;
                case 'copy_vendor':
                    copyField('vendor', idx);
                    break;
                case 'copy_all':
                    copyField('all', idx);
                    break;
            }

            // Reset the dropdown back to placeholder after action
            const dropdowns = document.querySelectorAll('.action-dropdown');
            if (dropdowns[idx]) {
                dropdowns[idx].value = '';
            }
        }

        function goToIP(protocol, idx) {
            const device = allDevices[idx];
            if (!device) return;

            const ip = device.ip;

            // Use SSH modal for SSH connections
            if (protocol === 'ssh') {
                openSSH(ip);
                // Close dropdown
                document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
                return;
            }

            let url = '';
            switch(protocol) {
                case 'http':
                    url = `http://${ip}`;
                    break;
                case 'https':
                    url = `https://${ip}`;
                    break;
                case 'rtsp':
                    url = `rtsp://${ip}`;
                    break;
            }

            if (url) {
                window.open(url, '_blank');
            }

            // Close dropdown
            document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));
        }

        function openPort(ip, port) {
            // Handle SSH specially - open SSH terminal
            if (port === 22) {
                openSSH(ip);
                return;
            }

            // Determine protocol based on port number
            let protocol = 'http';
            let portSuffix = `:${port}`;

            // Standard HTTPS ports - no prompt needed
            if (port === 443) {
                protocol = 'https';
                portSuffix = '';
                const url = `${protocol}://${ip}${portSuffix}`;
                window.open(url, '_blank');
            }
            // Standard HTTP port - no prompt needed
            else if (port === 80) {
                protocol = 'http';
                portSuffix = '';
                const url = `${protocol}://${ip}${portSuffix}`;
                window.open(url, '_blank');
            }
            // Special protocols - open directly
            else if (port === 554) {
                window.open(`rtsp://${ip}:${port}`, '_blank');
            } else if (port === 21) {
                window.open(`ftp://${ip}:${port}`, '_blank');
            } else if (port === 3389) {
                window.open(`rdp://${ip}:${port}`, '_blank');
            }
            // Non-standard ports - show protocol selection modal
            else {
                showProtocolModal(ip, port);
            }
        }

        function showProtocolModal(ip, port) {
            const modal = document.getElementById('protocolModal');
            const ipDisplay = document.getElementById('protocolIP');
            const httpsLink = document.getElementById('protocolHttpsLink');
            const httpLink = document.getElementById('protocolHttpLink');

            ipDisplay.textContent = `${ip}:${port}`;
            httpsLink.href = `https://${ip}:${port}`;
            httpLink.href = `http://${ip}:${port}`;

            modal.style.display = 'flex';
        }

        function closeProtocolModal() {
            const modal = document.getElementById('protocolModal');
            modal.style.display = 'none';
        }

        function openSSH(ip) {
            // Show SSH terminal modal
            const modal = document.getElementById('sshModal');
            const iframe = document.getElementById('sshFrame');
            const ipDisplay = document.getElementById('sshIP');

            ipDisplay.textContent = ip;

            // Use a web-based SSH client (you can replace this URL with your preferred SSH client)
            // Option 1: Use WebSSH (if you have it installed)
            // iframe.src = `http://localhost:8022/ssh?hostname=${ip}&port=22`;

            // Option 2: Show connection info for now
            const isDarkMode = !document.body.classList.contains('light-mode');
            const colors = isDarkMode ? {
                bgPrimary: '#0d1117',
                bgSecondary: '#161b22',
                borderColor: '#30363d',
                textPrimary: '#c9d1d9',
                textSecondary: '#8b949e',
                textLink: '#58a6ff'
            } : {
                bgPrimary: '#ffffff',
                bgSecondary: '#f6f8fa',
                borderColor: '#d0d7de',
                textPrimary: '#24292f',
                textSecondary: '#57606a',
                textLink: '#0969da'
            };

            iframe.srcdoc = `
                <html>
                <head>
                    <style>
                        body {
                            font-family: monospace;
                            background: ${colors.bgPrimary};
                            color: ${colors.textPrimary};
                            padding: 20px;
                            margin: 0;
                        }
                        .box {
                            background: ${colors.bgSecondary};
                            border: 1px solid ${colors.borderColor};
                            border-radius: 6px;
                            padding: 20px;
                            margin: 20px 0;
                        }
                        h2 {
                            color: ${colors.textLink};
                            margin-top: 0;
                        }
                        .command {
                            background: ${colors.bgPrimary};
                            border: 1px solid ${colors.borderColor};
                            padding: 12px;
                            border-radius: 6px;
                            font-size: 14px;
                            margin: 10px 0;
                            user-select: all;
                            cursor: pointer;
                        }
                        .command:hover {
                            background: ${colors.bgSecondary};
                        }
                        .note {
                            color: ${colors.textSecondary};
                            font-size: 12px;
                            margin-top: 15px;
                        }
                        a {
                            color: ${colors.textLink};
                            text-decoration: none;
                        }
                        a:hover {
                            text-decoration: underline;
                        }
                    </style>
                </head>
                <body>
                    <div class="box">
                        <h2>üîê SSH Connection to ${ip}</h2>

                        <p><strong>Connect via Terminal:</strong></p>
                        <div class="command" onclick="navigator.clipboard.writeText('ssh user@${ip}').then(() => alert('Copied to clipboard!'))" title="Click to copy">
                            ssh user@${ip}
                        </div>

                        <p><strong>Or with custom port:</strong></p>
                        <div class="command" onclick="navigator.clipboard.writeText('ssh -p 22 user@${ip}').then(() => alert('Copied to clipboard!'))" title="Click to copy">
                            ssh -p 22 user@${ip}
                        </div>

                        <div class="note">
                            üí° Click any command to copy to clipboard<br>
                            üí° Replace "user" with your actual username<br>
                            üí° You can also use PuTTY, WinSCP, or other SSH clients
                        </div>
                    </div>

                    <div class="box">
                        <h2>üåê Web-based SSH Options:</h2>
                        <p>‚Ä¢ <a href="https://${ip}:4200" target="_blank">Wetty SSH (if installed)</a></p>
                        <p>‚Ä¢ <a href="https://${ip}:2222" target="_blank">ttyd SSH (if installed)</a></p>
                        <p>‚Ä¢ Use your Home Assistant SSH addon terminal</p>
                    </div>
                </body>
                </html>
            `;

            modal.style.display = 'flex';
        }

        function closeSSHModal() {
            const modal = document.getElementById('sshModal');
            modal.style.display = 'none';
        }

        // Ping functionality
        let currentPingIP = null;
        let pingCount = 0;

        function startPing(idx) {
            const device = allDevices[idx];
            if (!device) return;

            currentPingIP = device.ip;
            pingCount = 0;

            const modal = document.getElementById('pingModal');
            const ipDisplay = document.getElementById('pingIP');
            const output = document.getElementById('pingOutput');

            ipDisplay.textContent = currentPingIP;
            output.innerHTML = '';

            // Close dropdown
            document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.remove('show'));

            modal.style.display = 'flex';

            // Run initial 8 pings
            runPings(8);
        }

        async function runPings(count) {
            const output = document.getElementById('pingOutput');
            const moreBtn = document.getElementById('pingMoreBtn');

            moreBtn.disabled = true;
            moreBtn.textContent = 'Pinging...';

            for (let i = 0; i < count; i++) {
                pingCount++;
                const start = Date.now();

                try {
                    // Simulate ping using fetch with timeout
                    const controller = new AbortController();
                    const timeout = setTimeout(() => controller.abort(), 2000);

                    const response = await fetch(`http://${currentPingIP}`, {
                        method: 'HEAD',
                        mode: 'no-cors',
                        signal: controller.signal
                    }).catch(() => null);

                    clearTimeout(timeout);
                    const time = Date.now() - start;

                    const line = document.createElement('div');
                    line.className = 'ping-success';
                    line.textContent = `Ping ${pingCount}: Reply from ${currentPingIP} time=${time}ms`;
                    output.appendChild(line);
                } catch (error) {
                    const time = Date.now() - start;
                    const line = document.createElement('div');
                    line.className = 'ping-fail';
                    line.textContent = `Ping ${pingCount}: Request timeout (${time}ms)`;
                    output.appendChild(line);
                }

                // Auto-scroll to bottom
                output.scrollTop = output.scrollHeight;

                // Small delay between pings
                if (i < count - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }

            moreBtn.disabled = false;
            moreBtn.textContent = 'Ping 8 More';
        }

        function runMorePings() {
            runPings(8);
        }

        function closePingModal() {
            const modal = document.getElementById('pingModal');
            modal.style.display = 'none';
            currentPingIP = null;
            pingCount = 0;
        }

        // Auto-refresh toggle
        let autoRefreshEnabled = true; // ON by default

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const toggle = document.getElementById('autoRefreshToggle');

            if (autoRefreshEnabled) {
                toggle.classList.add('active');
                if (!autoRefreshInterval) {
                    autoRefreshInterval = setInterval(refreshResults, 5000);
                }
            } else {
                toggle.classList.remove('active');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        // Theme toggle
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const isLightMode = body.classList.toggle('light-mode');

            // Update icon
            themeIcon.textContent = isLightMode ? 'üåô' : '‚òÄÔ∏è';

            // Save preference
            localStorage.setItem('theme', isLightMode ? 'light' : 'dark');
        }

        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            const themeIcon = document.getElementById('themeIcon');

            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                themeIcon.textContent = 'üåô';
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            // Don't close if clicking inside a dropdown
            if (!e.target.closest('.dropdown-menu') && !e.target.closest('.action-btn')) {
                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                    menu.classList.remove('dropdown-up');
                });
            }
        });

        // Prevent dropdown from closing when clicking items (let actions handle closing)
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(e) {
                if (e.target.closest('.dropdown-item')) {
                    e.stopPropagation();
                }
            });
        });

        async function exportJSON() {
            try {
                const response = await apiCall('api/export/json');
                if (!response.ok) throw new Error('Export failed');

                const data = await response.json();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `network-scan-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting JSON:', error);
                alert('Failed to export JSON');
            }
        }

        async function exportCSV() {
            try {
                const response = await apiCall('api/export/csv');
                if (!response.ok) throw new Error('Export failed');

                const data = await response.json();
                const blob = new Blob([data.csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `network-scan-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Failed to export CSV');
            }
        }

        // Initialize auto-refresh (ON by default)
        autoRefreshInterval = setInterval(refreshResults, 5000);
        document.getElementById('autoRefreshToggle').classList.add('active');

        // Load saved theme
        loadTheme();

        updateSubnetTags();
        refreshResults();
    </script>
</body>
</html>
